<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÛŒØ³ØªÛ•Ù…ÛŒ Ú©Û†Ú¯Ø§ Ùˆ ÙØ±ÙˆØ´ØªÙ†</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Kufi+Arabic:wght@500;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Noto Kufi Arabic';
        }
        
        body {
            font-family: 'Noto Kufi Arabic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            direction: rtl;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            padding: 30px;
            text-align: center;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .main-content {
            padding: 30px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 30px;
            background: #f5f5f5;
            border-radius: 15px;
            padding: 5px;
        }
        
        .tab {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            color: #666;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 2px solid #f0f0f0;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }
        
        .card h3 {
            color: #2196F3;
            margin-bottom: 20px;
            font-size: 1.4em;
            border-bottom: 3px solid #2196F3;
            padding-bottom: 10px;
        }
        
        .form-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .form-group > * {
            flex: 1;
            min-width: 200px;
        }
        
        .form-control {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            width: 100%;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 10px rgba(33, 150, 243, 0.2);
        }
        
        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #f44336, #e53935);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th, td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            color: white;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        tbody tr:hover {
            background: #f8f9ff;
            transform: scale(1.01);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .delete-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .delete-btn:hover {
            background: #e53935;
        }
        
        @media (max-width: 1024px) {
            .container {
                max-width: 98vw;
                padding: 10px;
            }
            .main-content {
                padding: 10px;
            }
            .header h1 {
                font-size: 2em;
            }
        }
        @media (max-width: 768px) {
            .form-group {
                flex-direction: column;
            }
            .form-group > * {
                min-width: 100%;
            }
            .tabs {
                flex-direction: column;
            }
            .header h1 {
                font-size: 1.5em;
            }
            .card {
                padding: 10px;
            }
            .stat-card {
                padding: 10px;
            }
            th, td {
                padding: 8px;
                font-size: 0.95em;
            }
            .btn, .btn-primary, .btn-success, .btn-danger {
                padding: 10px 15px;
                font-size: 14px;
            }
        }
        @media (max-width: 480px) {
            .container {
                border-radius: 8px;
                padding: 2px;
            }
            .header {
                padding: 10px;
            }
            .header h1 {
                font-size: 1.1em;
            }
            .main-content {
                padding: 2px;
            }
            .tabs button {
                font-size: 13px;
                padding: 8px 5px;
            }
        }

        .sale-product-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .sale-product-row .form-control {
            margin: 0;
        }

        .sale-product-row button {
            width: auto;
        }

        .sale-type {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .sale-type.cash {
            background: #e3f2fd;
            color: #1976d2;
        }

        .sale-type.installment {
            background: #fff3e0;
            color: #f57c00;
        }

        /* Modal Styles */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.6); 
            padding-top: 60px;
            animation: fadeInModal 0.5s;
        }

        @keyframes fadeInModal {
            from { background-color: rgba(0,0,0,0); }
            to { background-color: rgba(0,0,0,0.6); }
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; 
            padding: 30px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
            animation: slideIn 0.5s;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close-button {
            color: #aaa;
            float: left; /* For RTL */
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            left: 20px;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸª Ø³ÛŒØ³ØªÛ•Ù…ÛŒ Ú©Û†Ú¯Ø§ Ùˆ ÙØ±ÙˆØ´ØªÙ†</h1>
            <p>Ø¨Û•Ú•ÛÙˆÛ•Ø¨Ø±Ø¯Ù†ÛŒ Ø¨Û•Ø±Ù‡Û•Ù…Û•Ú©Ø§Ù† Ùˆ ÙØ±ÙˆØ´ØªÙ† Ø¨Û• Ø´ÛÙˆÛ•ÛŒÛ•Ú©ÛŒ Ù¾ÛŒØ´Û•ÛŒÛŒ</p>
        </div>
        
        <div class="main-content">
            <div class="tabs">
                <button class="tab active" onclick="showTab('inventory')">Ú©Û†Ú¯Ø§</button>
                <button class="tab" onclick="showTab('sales')">ÙØ±ÙˆØ´ØªÙ†</button>
                <button class="tab" onclick="showTab('reports')">Ú•Ø§Ù¾Û†Ø±ØªÛ•Ú©Ø§Ù†</button>
            </div>
            
            <!-- Ú©Û†Ú¯Ø§ Tab -->
            <div id="inventory" class="tab-content active">
                <div class="card">
                    <h3>ğŸ”‹ Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†ÛŒ Ø¨Û•Ø±Ù‡Û•Ù…ÛŒ Ù†ÙˆÛ</h3>
                    <div class="form-group">
                        <input type="text" id="productName" placeholder="Ù†Ø§ÙˆÛŒ Ø¨Û•Ø±Ù‡Û•Ù…" class="form-control">
                        <input type="number" id="productPrice" placeholder="Ù†Ø±Ø®" class="form-control">
                        <input type="number" id="productQuantity" placeholder="Ú˜Ù…Ø§Ø±Û•ÛŒ Ø¯Ø§Ù†Û•" class="form-control">
                    </div>
                    <div class="form-group">
                        <input type="date" id="purchaseDate" class="form-control" title="Ø¨Û•Ø±ÙˆØ§Ø±ÛŒ Ú©Ú•ÛŒÙ†">
                    </div>
                    <button onclick="addProduct()" class="btn btn-primary">Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†ÛŒ Ø¨Û•Ø±Ù‡Û•Ù…</button>
                </div>
                
                <div class="card">
                    <h3>ğŸ“¦ Ù„ÛŒØ³ØªÛŒ Ø¨Û•Ø±Ù‡Û•Ù…Û•Ú©Ø§Ù†</h3>
                    <div class="table-container">
                        <table id="inventoryTable">
                            <thead>
                                <tr>
                                    <th>Ù†Ø§ÙˆÛŒ Ø¨Û•Ø±Ù‡Û•Ù…</th>
                                    <th>Ù†Ø±Ø® (IQD)</th>
                                    <th>Ú˜Ù…Ø§Ø±Û•</th>
                                    <th>Ø¨Û•Ø±ÙˆØ§Ø±ÛŒ Ú©Ú•ÛŒÙ†</th>
                                    <th>Ú©Ø±Ø¯Ø§Ø±Û•Ú©Ø§Ù†</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- ÙØ±ÙˆØ´ØªÙ† Tab -->
            <div id="sales" class="tab-content">
                <div class="card">
                    <h3>ğŸ’° ÙØ±ÙˆØ´ØªÙ†ÛŒ Ø¨Û•Ø±Ù‡Û•Ù…</h3>
                    <form id="saleForm">
                        <div id="saleProductsContainer">
                            <div class="form-group sale-product-row">
                                <select class="form-control saleProductSelect">
                                    <option value="">Ø¨Û•Ø±Ù‡Û•Ù… Ø¯ÛŒØ§Ø±ÛŒ Ø¨Ú©Û•</option>
                                </select>
                                <input type="number" class="form-control saleQuantity" placeholder="Ú˜Ù…Ø§Ø±Û•ÛŒ ÙØ±Û†Ø´Ø±Ø§Ùˆ" min="1">
                                <button type="button" class="btn btn-danger" onclick="removeSaleProductRow(this)">Ù„Ø§Ø¨Ø±Ø¯Ù†</button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="addSaleProductRow()">
                            Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†ÛŒ Ø¨Û•Ø±Ù‡Û•Ù…ÛŒ ØªØ± +
                        </button>
                        <div class="form-group">
                            <select id="saleType" class="form-control">
                                <option value="cash">ÙØ±Û†Ø´ØªÙ†ÛŒ Ú•Ø§Ø³ØªÛ•ÙˆØ®Û†</option>
                                <option value="installment">ÙØ±Û†Ø´ØªÙ†ÛŒ Ù‚ÛŒØ³Øª</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <input type="date" id="saleDate" class="form-control">
                        </div>
                        <div class="form-group">
                            <input type="text" id="customerName" placeholder="Ù†Ø§ÙˆÛŒ Ú©Ú•ÛŒØ§Ø±" class="form-control">
                            <input type="text" id="customerLocation" placeholder="Ø´ÙˆÛÙ†ÛŒ Ú©Ú•ÛŒØ§Ø±" class="form-control">
                            <input type="tel" id="customerPhone" placeholder="Ú˜Ù…Ø§Ø±Û•ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„" class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <input type="number" id="totalPriceInput" placeholder="Ú©Û†ÛŒ Ù†Ø±Ø®" class="form-control">
                        </div>
                        
                        <div id="installmentFields" style="display:none;">
                            <div class="form-group">
                                <input type="text" id="customerGuarantor" placeholder="Ù†Ø§ÙˆÛŒ Ú©Û•ÙÛŒÙ„" class="form-control">
                            </div>
                            <div class="form-group">
                                <input type="number" id="dayAmpere" placeholder="Ø¦Û•Ù…Ù¾ÛØ± Ø±Û†Ú˜" class="form-control">
                                <input type="number" id="nightAmpere" placeholder="Ø¦Û•Ù…Ù¾ÛØ± Ø´Û•Ùˆ" class="form-control">
                            </div>
                            <div class="form-group">
                                <input type="number" id="downPayment" placeholder="Ø¨Ú•ÛŒ Ù¾Ø§Ø±Û•ÛŒ Ø¯Ø±Ø§Ùˆ" class="form-control">
                                <input type="number" id="remainingAmount" placeholder="Ø¨Ú•ÛŒ Ù¾Ø§Ø±Û•ÛŒ Ù…Ø§ÙˆÛ•" class="form-control" readonly>
                            </div>
                        </div>
                        
                        <button type="button" onclick="makeSale()" class="btn btn-success">ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø¯Ù†ÛŒ ÙØ±Û†Ø´ØªÙ†</button>
                    </form>
                </div>
                
                <div class="card">
                    <h3>ğŸ›’ Ù„ÛŒØ³ØªÛŒ ÙØ±ÙˆØ´ØªÙ†Û•Ú©Ø§Ù†</h3>
                    <div class="form-group">
                        <input type="text" id="salesSearchInput" class="form-control" placeholder="Ú¯Û•Ú•Ø§Ù† Ø¨Û•Ù¾ÛÛŒ Ù†Ø§ÙˆÛŒ Ú©Ú•ÛŒØ§Ø± ÛŒØ§Ù† Ú˜Ù…Ø§Ø±Û•ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„...">
                    </div>
                    <div class="table-container">
                        <table id="salesTable">
                            <thead>
                                <tr>
                                    <th>Ø¨Û•Ø±ÙˆØ§Ø±</th>
                                    <th>Ù†Ø§ÙˆÛŒ Ú©Ú•ÛŒØ§Ø±</th>
                                    <th>Ø¬Û†Ø±ÛŒ ÙØ±Û†Ø´ØªÙ†</th>
                                    <th>Ú©Û†ÛŒ Ù†Ø±Ø®</th>
                                    <th>Ú©Û†ÛŒ Ù¾Ø§Ø±Û•ÛŒ Ø¯Ø±Ø§Ùˆ</th>
                                    <th>Ù¾Ø§Ø±Û•ÛŒ Ù…Ø§ÙˆÛ•</th>
                                    <th>Ú©Ø±Ø¯Ø§Ø±Û•Ú©Ø§Ù†</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Ú•Ø§Ù¾Û†Ø±ØªÛ•Ú©Ø§Ù† Tab -->
            <div id="reports" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Ú©Û†ÛŒ Ø¯Ø§Ù‡Ø§ØªÛŒ Ù…Ø§Ù†Ú¯Ø§Ù†Û•</div>
                        <div class="stat-value" id="monthlyRevenue">0</div>
                        <div>Ø¯ÛŒÙ†Ø§Ø± Ø¹ÛØ±Ø§Ù‚ÛŒ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Ú©Û†ÛŒ Ø¯Ø§Ù‡Ø§ØªÛŒ Ø³Ø§Ù„Ø§Ù†Û•</div>
                        <div class="stat-value" id="yearlyRevenue">0</div>
                        <div>Ø¯ÛŒÙ†Ø§Ø± Ø¹ÛØ±Ø§Ù‚ÛŒ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Ú©Û†ÛŒ Ø¨Û•Ø±Ù‡Û•Ù…Û•Ú©Ø§Ù†</div>
                        <div class="stat-value" id="totalProducts">0</div>
                        <div>Ø¯Ø§Ù†Û•</div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>ğŸ“Š Ú•Ø§Ù¾Û†Ø±ØªÛŒ ØªÛ•ÙØµÛŒÙ„ÛŒ</h3>
                    <div class="form-group">
                        <select id="reportType" class="form-control">
                            <option value="monthly">Ú•Ø§Ù¾Û†Ø±ØªÛŒ Ù…Ø§Ù†Ú¯Ø§Ù†Û•</option>
                            <option value="yearly">Ú•Ø§Ù¾Û†Ø±ØªÛŒ Ø³Ø§Ù„Ø§Ù†Û•</option>
                            <option value="installment">Ú•Ø§Ù¾Û†Ø±ØªÛŒ ÙØ±Û†Ø´ØªÙ†ÛŒ Ù‚ÛŒØ³Øª</option>
                        </select>
                        <input type="month" id="reportMonth" class="form-control">
                        <button onclick="generateReport()" class="btn btn-primary">Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ø¯Ù†ÛŒ Ú•Ø§Ù¾Û†Ø±Øª</button>
                    </div>
                    <div id="reportResult"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for adding installment payment -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closePaymentModal()">&times;</span>
            <h3>Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†ÛŒ Ù¾Ø§Ø±Û•ÛŒ Ù‚ÛŒØ³Øª</h3>
            <p>Ú©Ú•ÛŒØ§Ø±: <span id="modalCustomerName"></span></p>
            <div class="form-group">
                <input type="number" id="modalPaymentAmount" placeholder="Ø¨Ú•ÛŒ Ù¾Ø§Ø±Û•ÛŒ Ø²ÛŒØ§Ø¯Ú©Ø±Ø§Ùˆ" class="form-control">
            </div>
            <div class="form-group">
                <input type="date" id="modalPaymentDate" class="form-control">
            </div>
            <button id="modalSubmitButton" class="btn btn-success">Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†</button>
        </div>
    </div>

    <!-- Modal for viewing payment history -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeHistoryModal()">&times;</span>
            <h3>Ù…ÛÚ˜ÙˆÙˆÛŒ Ù¾Ø§Ø±Û•Ø¯Ø§Ù†</h3>
            <p>Ú©Ú•ÛŒØ§Ø±: <span id="historyCustomerName"></span></p>
            <div class="table-container" style="margin-top: 20px;">
                <table id="historyTable">
                    <thead>
                        <tr>
                            <th>Ø¨Û•Ø±ÙˆØ§Ø±</th>
                            <th>Ø¨Ú•ÛŒ Ù¾Ø§Ø±Û• (IQD)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Ú¯Û†Ú•Ø§ÙˆÛ•Ú©Ø§Ù†
        let products = [];
        let sales = [];
        let nextProductId = 1;
        let nextSaleId = 1;

        // =================================================
        // Local Storage Functions for Data Persistence
        // =================================================
        function saveData() {
            try {
                localStorage.setItem('inventoryAppProducts', JSON.stringify(products));
                localStorage.setItem('inventoryAppSales', JSON.stringify(sales));
                localStorage.setItem('inventoryAppNextProductId', nextProductId.toString());
                localStorage.setItem('inventoryAppNextSaleId', nextSaleId.toString());
            } catch (e) {
                console.error("Error saving data to localStorage", e);
                alert("Ù†Û•ØªÙˆØ§Ù†Ø±Ø§ Ø¯Ø§ØªØ§ Ù¾Ø§Ø´Û•Ú©Û•ÙˆØª Ø¨Ú©Ø±ÛØª. Ú•Û•Ù†Ú¯Û• Ø¨ÛŒØ±Ú¯Û•ÛŒ ÙˆÛØ¨Ú¯Û•Ú•Û•Ú©Û•Øª Ù¾Ú• Ø¨ÙˆØ¨ÛØª.");
            }
        }

        function loadData() {
            const storedProducts = localStorage.getItem('inventoryAppProducts');
            const storedSales = localStorage.getItem('inventoryAppSales');
            const storedNextProductId = localStorage.getItem('inventoryAppNextProductId');
            const storedNextSaleId = localStorage.getItem('inventoryAppNextSaleId');

            if (storedProducts) products = JSON.parse(storedProducts);
            if (storedSales) sales = JSON.parse(storedSales);
            if (storedNextProductId) nextProductId = parseInt(storedNextProductId, 10);
            if (storedNextSaleId) nextSaleId = parseInt(storedNextSaleId, 10);
        }

        // ÙÛ•Ù†Ú©Ø´Ù†ÛŒ Ù¾ÛŒØ´Ø§Ù†Ø¯Ø§Ù†ÛŒ ØªØ§Ø¨Û•Ú©Ø§Ù†
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'reports') {
                updateStatistics();
            }
        }

        // Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†ÛŒ Ø¨Û•Ø±Ù‡Û•Ù…
        function addProduct() {
            const name = document.getElementById('productName').value;
            const price = parseFloat(document.getElementById('productPrice').value);
            const quantity = parseInt(document.getElementById('productQuantity').value);
            const purchaseDate = document.getElementById('purchaseDate').value;

            if (!name || !price || !quantity || !purchaseDate) {
                alert('ØªÚ©Ø§ÛŒÛ• Ù‡Û•Ù…ÙˆÙˆ Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛŒÛ•Ú©Ø§Ù† Ù¾Ú• Ø¨Ú©Û•Ø±Û•ÙˆÛ•!');
                return;
            }

            const product = {
                id: nextProductId++,
                name: name,
                price: price,
                quantity: quantity,
                purchaseDate: purchaseDate
            };

            products.push(product);
            updateInventoryTable();
            updateSaleProductSelect();
            clearProductForm();
            saveData();
            alert('Ø¨Û•Ø±Ù‡Û•Ù… Ø¨Û• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆÛŒ Ø²ÛŒØ§Ø¯ Ú©Ø±Ø§!');
        }

        // Ù†ÙˆÛÚ©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ø®Ø´ØªÛ•ÛŒ Ú©Û†Ú¯Ø§
        function updateInventoryTable() {
            const tbody = document.querySelector('#inventoryTable tbody');
            tbody.innerHTML = '';

            products.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.name}</td>
                    <td>${product.price.toLocaleString()} IQD</td>
                    <td>${product.quantity}</td>
                    <td>${product.purchaseDate}</td>
                    <td><button class="delete-btn" onclick="deleteProduct(${product.id})">Ø³Ú•ÛŒÙ†Û•ÙˆÛ•</button></td>
                `;
                tbody.appendChild(row);
            });
        }

        // Ø³Ú•ÛŒÙ†Û•ÙˆÛ•ÛŒ Ø¨Û•Ø±Ù‡Û•Ù…
        function deleteProduct(id) {
            if (confirm('Ø¯ÚµÙ†ÛŒØ§ÛŒÛŒ Ù„Û• Ø³Ú•ÛŒÙ†Û•ÙˆÛ•ÛŒ Ø¦Û•Ù… Ø¨Û•Ø±Ù‡Û•Ù…Û•ØŸ')) {
                products = products.filter(p => p.id !== id);
                updateInventoryTable();
                updateSaleProductSelect();
                saveData();
            }
        }

        // Ù†ÙˆÛÚ©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ù„ÛŒØ³ØªÛŒ Ø¨Û•Ø±Ù‡Û•Ù…Û•Ú©Ø§Ù† Ø¨Û† ÙØ±Û†Ø´ØªÙ†
        function updateSaleProductSelect() {
            const selects = document.querySelectorAll('.saleProductSelect');
            selects.forEach(select => {
                select.innerHTML = '<option value="">Ø¨Û•Ø±Ù‡Û•Ù… Ø¯ÛŒØ§Ø±ÛŒ Ø¨Ú©Û•</option>';
                products.forEach(product => {
                    if (product.quantity > 0) {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = `${product.name} (${product.quantity} Ø¯Ø§Ù†Û•)`;
                        select.appendChild(option);
                    }
                });
            });
        }

        // Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†ÛŒ Ø¯ÙˆÚ¯Ù…Û•ÛŒ Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†ÛŒ Ø¨Û•Ø±Ù‡Û•Ù… Ù„Û• ÙÛ†Ú•Ù…ÛŒ ÙØ±Û†Ø´ØªÙ†
function addSaleProductRow() {
    const container = document.getElementById('saleProductsContainer');
    const row = document.createElement('div');
    row.className = 'form-group sale-product-row';
    row.innerHTML = `
        <select class="form-control saleProductSelect">
            <option value="">Ø¨Û•Ø±Ù‡Û•Ù… Ø¯ÛŒØ§Ø±ÛŒ Ø¨Ú©Û•</option>
            ${products.map(p => `
                <option value="${p.id}">${p.name} (${p.quantity} Ø¯Ø§Ù†Û•)</option>
            `).join('')}
        </select>
        <input type="number" class="form-control saleQuantity" placeholder="Ú˜Ù…Ø§Ø±Û•ÛŒ ÙØ±Û†Ø´Ø±Ø§Ùˆ" min="1">
        <button type="button" class="btn btn-danger" onclick="removeSaleProductRow(this)">Ù„Ø§Ø¨Ø±Ø¯Ù†</button>
    `;
    container.appendChild(row);
    updateSaleProductSelect();
}

// Ù„Ø§Ø¨Ø±Ø¯Ù†ÛŒ Ú•ÛŒØ²ÛŒ Ø¨Û•Ø±Ù‡Û•Ù…
function removeSaleProductRow(button) {
    button.closest('.sale-product-row').remove();
}

// ÙØ±Û†Ø´ØªÙ†
function makeSale() {
    const saleType = document.getElementById('saleType').value;
    const date = document.getElementById('saleDate').value;
    const customerName = document.getElementById('customerName').value;
    const customerLocation = document.getElementById('customerLocation').value;
    const customerPhone = document.getElementById('customerPhone').value;

    // Ù¾Ø´Ú©Ù†ÛŒÙ†ÛŒ Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛŒÛ• Ø³Û•Ø±Û•Ú©ÛŒÛŒÛ•Ú©Ø§Ù†
    if (!date || !customerName || !customerLocation || !customerPhone) {
        alert('ØªÚ©Ø§ÛŒÛ• Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛŒÛ•Ú©Ø§Ù†ÛŒ Ú©Ú•ÛŒØ§Ø± ØªÛ•ÙˆØ§Ùˆ Ø¨Ú©Û•!');
        return;
    }

    // Ú©Û†Ú©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ Ø¨Û•Ø±Ù‡Û•Ù…Û•Ú©Ø§Ù†
    const productRows = document.querySelectorAll('.sale-product-row');
    const selectedProducts = [];

    for (const row of productRows) {
        const productId = parseInt(row.querySelector('.saleProductSelect').value);
        const quantity = parseInt(row.querySelector('.saleQuantity').value);

        if (!productId || !quantity) {
            alert('ØªÚ©Ø§ÛŒÛ• Ø¨Û•Ø±Ù‡Û•Ù… Ùˆ Ú˜Ù…Ø§Ø±Û• Ø¯ÛŒØ§Ø±ÛŒ Ø¨Ú©Û•!');
            return;
        }

        const product = products.find(p => p.id === productId);
        if (!product) continue;
        
        if (quantity > product.quantity) {
            alert(`Ú˜Ù…Ø§Ø±Û•ÛŒ Ø¯Ø§ÙˆØ§Ú©Ø±Ø§Ùˆ Ø¨Û† ${product.name} Ø²ÛŒØ§ØªØ±Û• Ù„Û• Ú˜Ù…Ø§Ø±Û•ÛŒ Ø¨Û•Ø±Ø¯Û•Ø³Øª!`);
            return;
        }

        selectedProducts.push({
            productId,
            productName: product.name,
            quantity,
            unitPrice: product.price,
            totalPrice: quantity * product.price
        });
    }

    if (selectedProducts.length === 0) {
        alert('ØªÚ©Ø§ÛŒÛ• Ù„Ø§Ù†ÛŒ Ú©Û•Ù… ÛŒÛ•Ú© Ø¨Û•Ø±Ù‡Û•Ù… Ø¯ÛŒØ§Ø±ÛŒ Ø¨Ú©Û•!');
        return;
    }

    // ÙˆÛ•Ø±Ú¯Ø±ØªÙ†ÛŒ Ù†Ø±Ø®ÛŒ Ú©Û†ÛŒ Ú¯Ø´ØªÛŒ Ø¨Û• Ø´ÛÙˆÛ•ÛŒ Ø¯Û•Ø³ØªÛŒ
    const manualTotalPrice = parseFloat(document.getElementById('totalPriceInput').value);
    if (isNaN(manualTotalPrice) || manualTotalPrice < 0) {
        alert('ØªÚ©Ø§ÛŒÛ• Ú©Û†ÛŒ Ù†Ø±Ø®ÛŒ ÙØ±Û†Ø´ØªÙ† Ø¨Û• Ø¯Ø±ÙˆØ³ØªÛŒ Ù¾Ú• Ø¨Ú©Û•Ø±Û•ÙˆÛ•!');
        return;
    }
    const totalSalePrice = manualTotalPrice;

    // Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ Ù‚ÛŒØ³Øª
    let installmentData = {};
    if (saleType === 'installment') {
        const customerGuarantor = document.getElementById('customerGuarantor').value;
        const dayAmpere = document.getElementById('dayAmpere').value;
        const nightAmpere = document.getElementById('nightAmpere').value;
        const downPayment = parseFloat(document.getElementById('downPayment').value) || 0;

        // Ù¾Ø´Ú©Ù†ÛŒÙ†ÛŒ Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛŒÛ• Ù¾ÛÙˆÛŒØ³ØªÛ•Ú©Ø§Ù†ÛŒ Ù‚ÛŒØ³Øª
        if (!customerGuarantor || isNaN(downPayment)) {
            alert('ØªÚ©Ø§ÛŒÛ• Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛŒÛ•Ú©Ø§Ù†ÛŒ Ù‚ÛŒØ³Øª ØªÛ•ÙˆØ§Ùˆ Ø¨Ú©Û•!');
            return;
        }

        const remainingAmount = totalSalePrice - downPayment;
        installmentData = {
            customerGuarantor,
            dayAmpere,
            nightAmpere,
            downPayment,
            remainingAmount: remainingAmount,
            paymentHistory: [{ amount: downPayment, date: date }]
        };
    }

    // ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø¯Ù†ÛŒ ÙØ±Û†Ø´ØªÙ†
    const sale = {
        id: nextSaleId++,
        date,
        customerName,
        customerLocation,
        customerPhone,
        saleType,
        products: selectedProducts,
        totalPrice: totalSalePrice,
        ...installmentData
    };

    // Ú©Û•Ù…Ú©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ú˜Ù…Ø§Ø±Û•ÛŒ Ø¨Û•Ø±Ù‡Û•Ù…Û•Ú©Ø§Ù†
    selectedProducts.forEach(sp => {
        const product = products.find(p => p.id === sp.productId);
        if (product) {
            product.quantity -= sp.quantity;
        }
    });

    // Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù† Ø¨Û† Ù„ÛŒØ³ØªÛŒ ÙØ±Û†Ø´ØªÙ†Û•Ú©Ø§Ù†
    sales.push(sale);
    
    // Ù†ÙˆÛÚ©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ø®Ø´ØªÛ•Ú©Ø§Ù†
    updateInventoryTable();
    updateSaleProductSelect();
    updateSalesTable();
    
    // Ù¾Ø§Ú©Ú©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ ÙÛ†Ú•Ù…
    clearSaleForm();
    
    saveData();
    alert('ÙØ±Û†Ø´ØªÙ† Ø¨Û• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆÛŒ ØªÛ†Ù…Ø§Ø± Ú©Ø±Ø§!');
}
        // Ù†ÙˆÛÚ©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ø®Ø´ØªÛ•ÛŒ ÙØ±Û†Ø´ØªÙ†Û•Ú©Ø§Ù†
        function updateSalesTable(salesToDisplay = sales) {
            const salesTbody = document.querySelector('#salesTable tbody');
            salesTbody.innerHTML = '';

            if (salesToDisplay.length === 0) {
                const row = salesTbody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 7;
                // Check if the main sales array is empty or if it's a failed search
                if (sales.length === 0) {
                    cell.textContent = 'Ù‡ÛŒÚ† ÙØ±Û†Ø´ØªÙ†ÛÚ© ØªÛ†Ù…Ø§Ø± Ù†Û•Ú©Ø±Ø§ÙˆÛ•';
                } else {
                    cell.textContent = 'Ù‡ÛŒÚ† ÙØ±Û†Ø´ØªÙ†ÛÚ© Ø¨Û•Ù… Ú¯Û•Ú•Ø§Ù†Û• Ù†Û•Ø¯Û†Ø²Ø±Ø§ÛŒÛ•ÙˆÛ•';
                }
                cell.style.textAlign = 'center';
                cell.style.padding = '20px';
                return;
            }

            salesToDisplay.forEach(sale => {
                const row = salesTbody.insertRow();
                
                row.insertCell().textContent = sale.date;
                row.insertCell().textContent = sale.customerName;
                
                const saleTypeCell = row.insertCell();
                saleTypeCell.innerHTML = `<span class="sale-type ${sale.saleType}">${sale.saleType === 'installment' ? 'ğŸ”„ Ù‚ÛŒØ³Øª' : 'ğŸ’µ Ù†Û•Ù‚Ø¯'}</span>`;

                row.insertCell().textContent = `${sale.totalPrice.toLocaleString()} IQD`;

                if (sale.saleType === 'installment') {
                    row.insertCell().textContent = `${(sale.downPayment || 0).toLocaleString()} IQD`;
                    row.insertCell().textContent = `${(sale.remainingAmount || 0).toLocaleString()} IQD`;
                } else {
                    row.insertCell().textContent = '-';
                    row.insertCell().textContent = '-';
                }

                const actionsCell = row.insertCell();
                actionsCell.style.whiteSpace = 'nowrap';
                let buttonsHTML = `<button class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;" onclick="editSale(${sale.id})">Ø¯Û•Ø³ØªÚ©Ø§Ø±ÛŒ</button>`;
                
                if (sale.saleType === 'installment') {
                    buttonsHTML += ` <button class="btn btn-success" style="padding: 5px 10px; font-size: 12px;" onclick="openPaymentModal(${sale.id})">Ø²ÛŒØ§Ø¯ Ú©Ø±Ø¯Ù†</button>`;
                }
                
                buttonsHTML += ` <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="deleteSale(${sale.id})">Ø³Ú•ÛŒÙ†Û•ÙˆÛ•</button>`;
                
                actionsCell.innerHTML = buttonsHTML;
            });
        }

        // Ø³Ú•ÛŒÙ†Û•ÙˆÛ•ÛŒ ÙØ±Û†Ø´ØªÙ†
        function deleteSale(id) {
            if (confirm('Ø¯ÚµÙ†ÛŒØ§ÛŒÛŒ Ù„Û• Ø³Ú•ÛŒÙ†Û•ÙˆÛ•ÛŒ Ø¦Û•Ù… ÙØ±Û†Ø´ØªÙ†Û•ØŸ Ù‡Û•Ù…ÙˆÙˆ Ø¨Û•Ø±Ù‡Û•Ù…Û•Ú©Ø§Ù† Ø¯Û•Ú¯Û•Ú•ÛÙ†Û•ÙˆÛ• Ú©Û†Ú¯Ø§.')) {
                const saleIndex = sales.findIndex(s => s.id === id);
                if (saleIndex > -1) {
                    const saleToDelete = sales[saleIndex];
                    
                    // Ú¯Û•Ú•Ø§Ù†Ø¯Ù†Û•ÙˆÛ•ÛŒ Ø¨Û•Ø±Ù‡Û•Ù…Û• ÙØ±Û†Ø´Ø±Ø§ÙˆÛ•Ú©Ø§Ù† Ø¨Û† Ú©Û†Ú¯Ø§
                    saleToDelete.products.forEach(soldProduct => {
                        const productInInventory = products.find(p => p.id === soldProduct.productId);
                        if (productInInventory) {
                            productInInventory.quantity += soldProduct.quantity;
                        }
                    });

                    // Ø³Ú•ÛŒÙ†Û•ÙˆÛ•ÛŒ ÙØ±Û†Ø´ØªÙ†Û•Ú©Û•
                    sales.splice(saleIndex, 1);
                    
                    updateInventoryTable();
                    updateSaleProductSelect();
                    updateSalesTable();
                    saveData();
                    alert('ÙØ±Û†Ø´ØªÙ† Ø¨Û• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆÛŒÛŒ Ø³Ú•Ø§ÛŒÛ•ÙˆÛ•.');
                }
            }
        }

        // Ú©Ø§Ø±Û•Ú©Ø§Ù†ÛŒ Ù…Û†Ø¯Ø§Ù„ÛŒ Ù¾Ø§Ø±Û•Ø¯Ø§Ù†
        function openPaymentModal(saleId) {
            const sale = sales.find(s => s.id === saleId);
            if (!sale) return;

            const modal = document.getElementById('paymentModal');
            document.getElementById('modalCustomerName').textContent = sale.customerName;
            document.getElementById('modalPaymentAmount').value = '';
            document.getElementById('modalPaymentDate').valueAsDate = new Date();
            
            const submitButton = document.getElementById('modalSubmitButton');
            submitButton.onclick = () => submitPayment(saleId);

            modal.style.display = "block";
        }

        function closePaymentModal() {
            const modal = document.getElementById('paymentModal');
            modal.style.display = "none";
        }

        function submitPayment(saleId) {
            const sale = sales.find(s => s.id === saleId);
            if (!sale) return;

            const paymentAmount = parseFloat(document.getElementById('modalPaymentAmount').value);
            const paymentDate = document.getElementById('modalPaymentDate').value;

            if (isNaN(paymentAmount) || paymentAmount <= 0) {
                alert("ØªÚ©Ø§ÛŒÛ• Ø¨Ú•ÛÚ©ÛŒ Ø¯Ø±ÙˆØ³Øª Ø¨Ù†ÙˆÙˆØ³Û•!");
                return;
            }

            if (!paymentDate) {
                alert("ØªÚ©Ø§ÛŒÛ• Ø¨Û•Ø±ÙˆØ§Ø± Ø¯ÛŒØ§Ø±ÛŒ Ø¨Ú©Û•!");
                return;
            }

            if (paymentAmount > sale.remainingAmount) {
                alert(`Ø¨Ú•ÛŒ Ù¾Ø§Ø±Û• Ø²ÛŒØ§ØªØ±Û• Ù„Û• Ù¾Ø§Ø±Û•ÛŒ Ù…Ø§ÙˆÛ•! (${sale.remainingAmount.toLocaleString()} IQD)`);
                return;
            }

            if (!sale.paymentHistory) {
                sale.paymentHistory = [{ amount: sale.downPayment, date: sale.date }];
            }
            
            sale.paymentHistory.push({ amount: paymentAmount, date: paymentDate });

            sale.downPayment += paymentAmount;
            sale.remainingAmount -= paymentAmount;

            updateSalesTable();
            closePaymentModal();
            saveData();
            alert("Ù¾Ø§Ø±Û• Ùˆ Ø¨Û•Ø±ÙˆØ§Ø± Ø¨Û• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆÛŒÛŒ Ø²ÛŒØ§Ø¯Ú©Ø±Ø§!");
        }

        // Ù†ÙˆÛÚ©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ø¦Ø§Ù…Ø§Ø±Û•Ú©Ø§Ù†
        function updateStatistics() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            // Ø¯Ø§Ù‡Ø§ØªÛŒ Ù…Ø§Ù†Ú¯Ø§Ù†Û•
            const monthlyRevenue = sales
                .filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
                })
                .reduce((total, sale) => total + sale.totalPrice, 0);

            // Ø¯Ø§Ù‡Ø§ØªÛŒ Ø³Ø§Ù„Ø§Ù†Û•
            const yearlyRevenue = sales
                .filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate.getFullYear() === currentYear;
                })
                .reduce((total, sale) => total + sale.totalPrice, 0);

            // Ú©Û†ÛŒ Ø¨Û•Ø±Ù‡Û•Ù…Û•Ú©Ø§Ù†
            const totalProducts = products.reduce((total, product) => total + product.quantity, 0);

            document.getElementById('monthlyRevenue').textContent = monthlyRevenue.toLocaleString();
            document.getElementById('yearlyRevenue').textContent = yearlyRevenue.toLocaleString();
            document.getElementById('totalProducts').textContent = totalProducts;
        }

        // Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ø¯Ù†ÛŒ Ú•Ø§Ù¾Û†Ø±Øª
        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const reportMonth = document.getElementById('reportMonth').value;
            const resultDiv = document.getElementById('reportResult');

            let reportHtml = '<div class="card"><h3>Ú•Ø§Ù¾Û†Ø±ØªÛŒ ØªÛ•ÙØµÛŒÙ„ÛŒ</h3>';

            if (reportType === 'monthly' && reportMonth) {
                const [year, month] = reportMonth.split('-');
                const monthlyData = sales.filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate.getFullYear() == year && saleDate.getMonth() == (month - 1);
                });

                const totalRevenue = monthlyData.reduce((total, sale) => total + sale.totalPrice, 0);
                const totalQuantity = monthlyData.reduce((total, sale) => {
                    const saleQuantity = sale.products.reduce((subTotal, p) => subTotal + p.quantity, 0);
                    return total + saleQuantity;
                }, 0);

                reportHtml += `
                    <p><strong>Ú•Ø§Ù¾Û†Ø±ØªÛŒ Ù…Ø§Ù†Ú¯ÛŒ ${month}/${year}</strong></p>
                    <p>Ú©Û†ÛŒ Ø¯Ø§Ù‡Ø§Øª: ${totalRevenue.toLocaleString()} IQD</p>
                    <p>Ú©Û†ÛŒ ÙØ±Û†Ø´Ø±Ø§Ùˆ: ${totalQuantity} Ø¯Ø§Ù†Û•</p>
                    <p>Ú˜Ù…Ø§Ø±Û•ÛŒ ÙØ±Û†Ø´ØªÙ†: ${monthlyData.length} Ø¬Ø§Ø±</p>
                `;

                if (monthlyData.length > 0) {
                    reportHtml += '<div class="table-container"><table><thead><tr><th>Ø¨Û•Ø±ÙˆØ§Ø±</th><th>Ø¨Û•Ø±Ù‡Û•Ù…Û•Ú©Ø§Ù†</th><th>Ú©Ú•ÛŒØ§Ø±</th><th>Ø´ÙˆÛÙ†</th><th>Ù…ÙˆØ¨Ø§ÛŒÙ„</th><th>Ú©Û†ÛŒ Ú¯Ø´ØªÛŒ</th></tr></thead><tbody>';
                    monthlyData.forEach(sale => {
                        const productsList = sale.products.map(p => `${p.productName} (${p.quantity} Ø¯Ø§Ù†Û•)`).join('<br>');
                        reportHtml += `<tr>
                            <td>${sale.date}</td>
                            <td>${productsList}</td>
                            <td>${sale.customerName}</td>
                            <td>${sale.customerLocation}</td>
                            <td>${sale.customerPhone}</td>
                            <td>${sale.totalPrice.toLocaleString()} IQD</td>
                        </tr>`;
                    });
                    reportHtml += '</tbody></table></div>';
                }

            } else if (reportType === 'yearly') {
                const currentYear = new Date().getFullYear();
                const yearlyData = sales.filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate.getFullYear() === currentYear;
                });

                const totalRevenue = yearlyData.reduce((total, sale) => total + sale.totalPrice, 0);
                const totalQuantity = yearlyData.reduce((total, sale) => {
                    const saleQuantity = sale.products.reduce((subTotal, p) => subTotal + p.quantity, 0);
                    return total + saleQuantity;
                }, 0);

                reportHtml += `
                    <p><strong>Ú•Ø§Ù¾Û†Ø±ØªÛŒ Ø³Ø§ÚµÛŒ ${currentYear}</strong></p>
                    <p>Ú©Û†ÛŒ Ø¯Ø§Ù‡Ø§Øª: ${totalRevenue.toLocaleString()} IQD</p>
                    <p>Ú©Û†ÛŒ ÙØ±Û†Ø´Ø±Ø§Ùˆ: ${totalQuantity} Ø¯Ø§Ù†Û•</p>
                    <p>Ú˜Ù…Ø§Ø±Û•ÛŒ ÙØ±Û†Ø´ØªÙ†: ${yearlyData.length} Ø¬Ø§Ø±</p>
                `;

            } else if (reportType === 'installment') {
                reportHtml += '<p><strong>Ú•Ø§Ù¾Û†Ø±ØªÛŒ ÙØ±Û†Ø´ØªÙ†ÛŒ Ù‚ÛŒØ³Øª:</strong></p>';
                const installmentSales = sales.filter(s => s.saleType === 'installment');

                if (installmentSales.length > 0) {
                    const totalSold = installmentSales.reduce((total, sale) => total + sale.totalPrice, 0);
                    const totalPaid = installmentSales.reduce((total, sale) => total + (sale.downPayment || 0), 0);
                    const totalRemaining = installmentSales.reduce((total, sale) => total + (sale.remainingAmount || 0), 0);

                    reportHtml += `
                        <div style="margin: 15px 0; padding: 15px; background: #f0f8ff; border-radius: 8px;">
                            <h4>Ú©ÙˆØ±ØªÛ•ÛŒ Ú¯Ø´ØªÛŒ Ù‚ÛŒØ³ØªÛ•Ú©Ø§Ù†:</h4>
                            <p>â€¢ Ú©Û†ÛŒ ÙØ±Û†Ø´ØªÙ†ÛŒ Ù‚ÛŒØ³Øª: ${totalSold.toLocaleString()} IQD</p>
                            <p>â€¢ Ú©Û†ÛŒ Ù¾Ø§Ø±Û•ÛŒ ÙˆÛ•Ø±Ú¯ÛŒØ±Ø§Ùˆ: ${totalPaid.toLocaleString()} IQD</p>
                            <p>â€¢ Ú©Û†ÛŒ Ù¾Ø§Ø±Û•ÛŒ Ù…Ø§ÙˆÛ•: ${totalRemaining.toLocaleString()} IQD</p>
                            <p>â€¢ Ú˜Ù…Ø§Ø±Û•ÛŒ ÙØ±Û†Ø´ØªÙ†Û•Ú©Ø§Ù†: ${installmentSales.length} ÙØ±Û†Ø´ØªÙ†</p>
                        </div>
                    `;

                    reportHtml += '<div class="table-container"><table><thead><tr><th>Ù†Ø§ÙˆÛŒ Ú©Ú•ÛŒØ§Ø±</th><th>Ú©Û†ÛŒ Ù†Ø±Ø®</th><th>Ú©Û†ÛŒ Ù¾Ø§Ø±Û•ÛŒ Ø¯Ø±Ø§Ùˆ</th><th>Ù¾Ø§Ø±Û•ÛŒ Ù…Ø§ÙˆÛ•</th><th>Ú©Ø±Ø¯Ø§Ø±Û•Ú©Ø§Ù†</th></tr></thead><tbody>';
                    
                    installmentSales.forEach(sale => {
                        reportHtml += `<tr>
                            <td>${sale.customerName}</td>
                            <td>${sale.totalPrice.toLocaleString()} IQD</td>
                            <td>${(sale.downPayment || 0).toLocaleString()} IQD</td>
                            <td><strong>${(sale.remainingAmount || 0).toLocaleString()} IQD</strong></td>
                            <td><button class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;" onclick="showPaymentHistory(${sale.id})">Ø¨ÛŒÙ†ÛŒÙ†ÛŒ Ù…ÛÚ˜ÙˆÙˆ</button></td>
                        </tr>`;
                    });
                    reportHtml += '</tbody></table></div>';
                } else {
                    reportHtml += '<p>Ù‡ÛŒÚ† ÙØ±Û†Ø´ØªÙ†ÛÚ©ÛŒ Ù‚ÛŒØ³Øª ØªÛ†Ù…Ø§Ø± Ù†Û•Ú©Ø±Ø§ÙˆÛ•!</p>';
                }

            }

            reportHtml += '</div>';
            resultDiv.innerHTML = reportHtml;
        }

        function showPaymentHistory(saleId) {
            const sale = sales.find(s => s.id === saleId);
            if (!sale || !sale.paymentHistory || sale.paymentHistory.length === 0) {
                alert("Ù‡ÛŒÚ† Ù…ÛÚ˜ÙˆÙˆÛŒÛ•Ú©ÛŒ Ù¾Ø§Ø±Û•Ø¯Ø§Ù† Ø¨Û† Ø¦Û•Ù… ÙØ±Û†Ø´ØªÙ†Û• ØªÛ†Ù…Ø§Ø± Ù†Û•Ú©Ø±Ø§ÙˆÛ•.");
                return;
            }

            const modal = document.getElementById('historyModal');
            document.getElementById('historyCustomerName').textContent = sale.customerName;
            const historyTbody = document.querySelector('#historyTable tbody');
            historyTbody.innerHTML = ''; // Ù¾Ø§Ú©Ú©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ø¯Ø§ØªØ§ÛŒ Ù¾ÛØ´ÙˆÙˆ

            sale.paymentHistory.forEach(payment => {
                const row = historyTbody.insertRow();
                row.insertCell().textContent = payment.date;
                row.insertCell().textContent = `${payment.amount.toLocaleString()} IQD`;
            });

            modal.style.display = "block";
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').style.display = "none";
        }
        // Ù¾Ø§Ú©Ú©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ ÙÛ†Ú•Ù…Û•Ú©Ø§Ù†
        function clearProductForm() {
            document.getElementById('productName').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productQuantity').value = '';
            document.getElementById('purchaseDate').value = '';
        }

        function clearSaleForm() {
            // Ù¾Ø§Ú©Ú©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ù‡Û•Ù…ÙˆÙˆ ÙÛ†Ú•Ù…Û•Ú©Û•
            document.getElementById('saleProductsContainer').innerHTML = ''; // Ù¾Ø§Ú©Ú©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ù‡Û•Ù…ÙˆÙˆ Ø¨Û•Ø±Ù‡Û•Ù…Û•Ú©Ø§Ù†
            addSaleProductRow(); // Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†ÛŒ Ú•ÛŒØ²ÛÚ©ÛŒ Ù†ÙˆÛ

            // Ù¾Ø§Ú©Ú©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛŒÛ•Ú©Ø§Ù†ÛŒ ØªØ±
            document.getElementById('saleDate').valueAsDate = new Date();
            document.getElementById('customerName').value = '';
            document.getElementById('customerLocation').value = '';
            document.getElementById('customerPhone').value = '';
            
            // Ù¾Ø§Ú©Ú©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ø®Ø§Ù†Û•Ú©Ø§Ù†ÛŒ Ù‚ÛŒØ³Øª
            document.getElementById('customerGuarantor').value = '';
            document.getElementById('dayAmpere').value = '';
            document.getElementById('nightAmpere').value = '';
            document.getElementById('totalPriceInput').value = '';
            document.getElementById('downPayment').value = '';
            document.getElementById('remainingAmount').value = '';
            document.getElementById('downPayment').readOnly = false;

            // Ú¯Û•Ú•Ø§Ù†Û•ÙˆÛ• Ø¨Û† Ø¯Û†Ø®ÛŒ Ø¨Ù†Û•Ú•Û•Øª (ÙØ±Û†Ø´ØªÙ†ÛŒ Ù†Û•Ù‚Ø¯)
            document.getElementById('totalPriceInput').readOnly = false;
            document.getElementById('saleType').value = 'cash';
            document.getElementById('saleType').dispatchEvent(new Event('change'));
        }

        // Ø¯Ø§Ù…Û•Ø²Ø±Ø§Ù†Ø¯Ù†ÛŒ Ø¨Û•Ø±ÙˆØ§Ø±ÛŒ Ø¦Û•Ù…Ú•Û†
        document.getElementById('saleDate').valueAsDate = new Date();
        document.getElementById('purchaseDate').valueAsDate = new Date();

        // Load data from Local Storage on startup and update the UI
        loadData();
        updateInventoryTable();
        updateSaleProductSelect();
        updateSalesTable();

        // Ù¾ÛŒØ´Ø§Ù†Ø¯Ø§Ù†ÛŒ Ø®Ø§Ù†Û•ÛŒ Ù…Ø§Ù†Ú¯Û•Ú©Ø§Ù† ØªÛ•Ù†Ù‡Ø§ Ø¨Û† Ù‚ÛŒØ³Øª
        document.getElementById('saleType').addEventListener('change', function() {
            const installmentFields = document.getElementById('installmentFields');
            if (this.value === 'installment') {
                installmentFields.style.display = 'block';
            } else {
                installmentFields.style.display = 'none';
            }
        });

function editSale(saleId) {
    const sale = sales.find(s => s.id === saleId);
    if (!sale) return;

    // Ù¾Ú•Ú©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ ÙÛ†Ú•Ù…Û•Ú©Û• Ø¨Û• Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛŒÛ• Ú©Û†Ù†Û•Ú©Ø§Ù†
    document.getElementById('saleDate').value = sale.date;
    document.getElementById('customerName').value = sale.customerName;
    document.getElementById('customerLocation').value = sale.customerLocation;
    document.getElementById('customerPhone').value = sale.customerPhone;
    document.getElementById('saleType').value = sale.saleType;
    // Trigger change to show/hide fields correctly
    document.getElementById('saleType').dispatchEvent(new Event('change'));

    // Ù¾Ú•Ú©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ú©Û†ÛŒ Ù†Ø±Ø® Ø¯ÙˆØ§ÛŒ Ø¯ÛŒØ§Ø±ÛŒÚ©Ø±Ø¯Ù†ÛŒ Ø¬Û†Ø±Û•Ú©Û•ÛŒ
    document.getElementById('totalPriceInput').value = sale.totalPrice || '';

    // Ù¾Ú•Ú©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛŒÛ•Ú©Ø§Ù†ÛŒ Ù‚ÛŒØ³Øª Ø¦Û•Ú¯Û•Ø± Ù‡Û•Ø¨ÙˆÙˆ
    if (sale.saleType === 'installment') {
        document.getElementById('customerGuarantor').value = sale.customerGuarantor || '';
        document.getElementById('dayAmpere').value = sale.dayAmpere || '';
        document.getElementById('nightAmpere').value = sale.nightAmpere || '';
        document.getElementById('downPayment').value = sale.downPayment || '';
        document.getElementById('downPayment').readOnly = true;
        calculateRemaining();
    }
    // Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†ÛŒ Ø¨Û•Ø±Ù‡Û•Ù…Û•Ú©Ø§Ù†
    document.getElementById('saleProductsContainer').innerHTML = '';
    sale.products.forEach(product => {
        const row = document.createElement('div');
        row.className = 'form-group sale-product-row';
        row.innerHTML = `
            <select class="form-control saleProductSelect">
                <option value="${product.productId}">${product.productName}</option>
            </select>
            <input type="number" class="form-control saleQuantity" value="${product.quantity}" min="1">
            <button type="button" class="btn btn-danger" onclick="removeSaleProductRow(this)">Ù„Ø§Ø¨Ø±Ø¯Ù†</button>
        `;
        document.getElementById('saleProductsContainer').appendChild(row);
    });

    // Ú¯Û†Ú•ÛŒÙ†ÛŒ ØªÛ•Ù†Ù‡Ø§ Ø¯ÙˆÚ¯Ù…Û•ÛŒ ÙØ±Û†Ø´ØªÙ† Ø¨Û† Ù†ÙˆÛÚ©Ø±Ø¯Ù†Û•ÙˆÛ•
    const saleButton = document.querySelector('#saleForm .btn-success');
    if (saleButton) {
        saleButton.innerHTML = 'Ù†ÙˆÛÚ©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ ÙØ±Û†Ø´ØªÙ†';
        saleButton.onclick = function() { updateSale(saleId); };
    }

    // Ø³Ú©Ø±Û†Úµ Ú©Ø±Ø¯Ù† Ø¨Û† ÙÛ†Ú•Ù…ÛŒ ÙØ±Û†Ø´ØªÙ†
    document.getElementById('sales').scrollIntoView({ behavior: 'smooth' });
}

function updateSale(saleId) {
    const sale = sales.find(s => s.id === saleId);
    if (!sale) return;

    // Ú©Û†Ú©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛŒÛ• Ù†ÙˆÛÛŒÛ•Ú©Ø§Ù†
    const updatedSale = {
        ...sale,
        date: document.getElementById('saleDate').value,
        customerName: document.getElementById('customerName').value,
        customerLocation: document.getElementById('customerLocation').value,
        customerPhone: document.getElementById('customerPhone').value,
        saleType: document.getElementById('saleType').value,
    };

    // Ù†ÙˆÛÚ©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ø¨Û•Ø±Ù‡Û•Ù…Û•Ú©Ø§Ù†
    const productRows = document.querySelectorAll('.sale-product-row');
    updatedSale.products = Array.from(productRows).map(row => {
        const productId = parseInt(row.querySelector('.saleProductSelect').value);
        const quantity = parseInt(row.querySelector('.saleQuantity').value);
        const product = products.find(p => p.id === productId);

        return {
            productId,
            productName: product ? product.name : 'Unknown',
            quantity,
            unitPrice: product ? product.price : 0,
            totalPrice: product ? (quantity * product.price) : 0
        };
    });

    // Ù†ÙˆÛÚ©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛŒÛ•Ú©Ø§Ù†ÛŒ Ù‚ÛŒØ³Øª Ùˆ Ú©Û†ÛŒ Ù†Ø±Ø®
    const manualTotalPrice = parseFloat(document.getElementById('totalPriceInput').value);
    if (isNaN(manualTotalPrice) || manualTotalPrice < 0) {
         alert('ØªÚ©Ø§ÛŒÛ• Ú©Û†ÛŒ Ù†Ø±Ø® Ø¨Û• Ø¯Ø±ÙˆØ³ØªÛŒ Ù¾Ú• Ø¨Ú©Û•Ø±Û•ÙˆÛ•!');
         return;
    }
    updatedSale.totalPrice = manualTotalPrice;

    if (updatedSale.saleType === 'installment') {
        updatedSale.customerGuarantor = document.getElementById('customerGuarantor').value;
        updatedSale.dayAmpere = document.getElementById('dayAmpere').value;
        updatedSale.nightAmpere = document.getElementById('nightAmpere').value;

        updatedSale.remainingAmount = updatedSale.totalPrice - updatedSale.downPayment;
        
        // Ù¾Ø§Ú©Ú©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛŒÛ•Ú©Ø§Ù† Ú©Û• Ú†ÛŒØªØ± Ø¨Û•Ú©Ø§Ø±Ù†Ø§Ù‡ÛÙ†Ø±ÛÙ†
        delete updatedSale.installmentMonths;
        delete updatedSale.monthlyAmount;
    } else {
        // If type is not installment, remove installment-specific fields
        delete updatedSale.customerGuarantor;
        delete updatedSale.dayAmpere;
        delete updatedSale.nightAmpere;
        delete updatedSale.downPayment;
        delete updatedSale.installmentMonths;
        delete updatedSale.remainingAmount;
        delete updatedSale.monthlyAmount;
    }

    // Ù†ÙˆÛÚ©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ù„ÛŒØ³ØªÛŒ ÙØ±Û†Ø´ØªÙ†Û•Ú©Ø§Ù†
    sales = sales.map(s => s.id === saleId ? updatedSale : s);

    // Ù†ÙˆÛÚ©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ø®Ø´ØªÛ•Ú©Ø§Ù†
    updateSalesTable();
    updateInventoryTable();

    // Ú¯Û•Ú•Ø§Ù†Û•ÙˆÛ• Ø¨Û† Ø¯Û†Ø®ÛŒ Ø¦Ø§Ø³Ø§ÛŒÛŒ
    clearSaleForm();
    const saleButton = document.querySelector('button[onclick="updateSale(' + saleId + ')"]');
    saleButton.innerHTML = 'ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø¯Ù†ÛŒ ÙØ±Û†Ø´ØªÙ†';
    saleButton.onclick = makeSale;

    saveData();
    alert('ÙØ±Û†Ø´ØªÙ† Ø¨Û• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆÛŒÛŒ Ù†ÙˆÛÚ©Ø±Ø§ÛŒÛ•ÙˆÛ•!');
}

// Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†ÛŒ Ø¦Û•Ù… ÙÛ•Ù†Ú©Ø´Ù†Ø§Ù†Û• Ø¨Û† Ø­ÛŒØ³Ø§Ø¨Ú©Ø±Ø¯Ù†ÛŒ Ù‚ÛŒØ³Øª
function calculateRemaining() {
    const total = parseFloat(document.getElementById('totalPriceInput').value) || 0;
    const down = parseFloat(document.getElementById('downPayment').value) || 0;

    const remaining = total - down;
    document.getElementById('remainingAmount').value = remaining > 0 ? remaining : 0;
}

function calculateTotalPriceFromProducts() {
    const productRows = document.querySelectorAll('.sale-product-row');
    let total = 0;
    productRows.forEach(row => {
        const productId = parseInt(row.querySelector('.saleProductSelect').value);
        const quantity = parseInt(row.querySelector('.saleQuantity').value);
        const product = products.find(p => p.id === productId);
        if (productId && quantity && product) {
            total += product.price * quantity;
        }
    });
    
    // Ù†Ø±Ø®ÛŒ Ú©Û†ÛŒ Ú¯Ø´ØªÛŒ Ú†ÛŒØªØ± Ø¨Û• Ø´ÛÙˆÛ•ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ù†ÙˆÛ Ù†Ø§Ú©Ø±ÛØªÛ•ÙˆÛ• Ú†ÙˆÙ†Ú©Û• Ø¨Û• Ø¯Û•Ø³ØªÛŒ Ø¯Ø§Ø®Úµ Ø¯Û•Ú©Ø±ÛØª
}

// Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†ÛŒ event listener Ø¨Û† Ú¯Û†Ú•Ø§Ù†Ú©Ø§Ø±ÛŒ Ù„Û• ÙÛ†Ú•Ù…ÛŒ ÙØ±Û†Ø´ØªÙ†

document.getElementById('totalPriceInput').addEventListener('input', calculateRemaining);
document.getElementById('downPayment').addEventListener('input', calculateRemaining);

        // Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†ÛŒ Ú¯Û•Ú•Ø§Ù† Ø¨Û† Ù„ÛŒØ³ØªÛŒ ÙØ±Û†Ø´ØªÙ†Û•Ú©Ø§Ù†
        document.getElementById('salesSearchInput').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const filteredSales = sales.filter(sale => 
                sale.customerName.toLowerCase().includes(searchTerm) ||
                sale.customerPhone.includes(searchTerm)
            );
            updateSalesTable(filteredSales);
        });

        // Ø¯Ø§Ø®Ø³ØªÙ†ÛŒ Ù…Û†Ø¯Ø§Ù„ Ù„Û• Ú©Ø§ØªÛŒ Ú©Ø±ØªÛ•Ú©Ø±Ø¯Ù† Ù„Û• Ø¯Û•Ø±Û•ÙˆÛ•ÛŒ
        window.onclick = function(event) {
            const paymentModal = document.getElementById('paymentModal');
            const historyModal = document.getElementById('historyModal');
            if (event.target == paymentModal) {
                closePaymentModal();
            }
            if (event.target == historyModal) {
                closeHistoryModal();
            }
        }

    </script>
</body>
</html>